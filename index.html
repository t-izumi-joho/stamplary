<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ¡å†…ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
  <style>
    body { font-family: sans-serif; padding: 1em; text-align: center; }
    .stamp { font-size: 2em; margin: 0.5em; }
    .btn { margin: 1em; padding: 1em 2em; font-size: 1em; cursor: pointer; }
  </style>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <h1>ğŸ‰ æ ¡å†…ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ ğŸ‰</h1>
  <button class="btn" onclick="goToStamps()">ã‚¹ã‚¿ãƒ³ãƒ—å¸³ã‚’è¦‹ã‚‹</button>
  <button class="btn" onclick="startScan()">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>

  <div id="stamp-area" style="display:none">
    <h2>ğŸ“– ã‚¹ã‚¿ãƒ³ãƒ—å¸³</h2>
    <div id="stamps"></div>
    <button class="btn" onclick="goHome()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  </div>

  <div id="scanner" style="width: 300px; margin: auto; display:none;"></div>
  <div id="result"></div>

  <script>
    const stampList = [
      "é´è„±å ´","2å¹´7çµ„ï¼ˆæœ¬é¤¨ï¼–Fï¼‰", "éŸ³æ¥½å®¤å‰ (æ‰‰)", "å•é¡Œ-1",
      "2å¹´11çµ„ï¼ˆ3å·é¤¨4Fï¼‰", "3å¹´9çµ„æ¨¡æ“¬åº—", "ä½“è‚²é¤¨ï¼ˆå…¥å£ï¼‰",
      "ãƒãƒ«ãƒãƒ›ãƒ¼ãƒ«å‰","2å¹´9çµ„ï¼ˆæœ¬é¤¨8Fï¼‰", "å•é¡Œ-2",
    ];

    const stampImages = {
      "é´è„±å ´": "img/roomA.png",
      "2å¹´7çµ„ï¼ˆæœ¬é¤¨ï¼–Fï¼‰": "img/roomB.png",
      "éŸ³æ¥½å®¤å‰ (æ‰‰)": "img/roomC.png",
      "å•é¡Œ-1": "img/roomD.png",
      "ç†ç§‘å®¤å‰ (æ‰‰)": "img/roomD.png", // å•é¡Œ-1å–å¾—å¾Œã«è¡¨ç¤ºã™ã‚‹åå‰ã¨ç”»åƒ
      "2å¹´11çµ„ï¼ˆ3å·é¤¨4Fï¼‰": "img/roomE.png",
      "3å¹´9çµ„æ¨¡æ“¬åº—": "img/roomF.png",
      "ä½“è‚²é¤¨ï¼ˆå…¥å£ï¼‰": "img/roomG.png",
      "ãƒãƒ«ãƒãƒ›ãƒ¼ãƒ«å‰": "img/roomH.png",
      "2å¹´9çµ„ï¼ˆæœ¬é¤¨8Fï¼‰": "img/roomI.png",
      "å•é¡Œ-2": "img/roomJ.png",
      "å›³æ›¸é¤¨å‰": "img/roomJ.png",
    };

    function goToStamps() {
      document.getElementById('stamp-area').style.display = 'block';
      document.getElementById('scanner').style.display = 'none';
      renderStamps();
    }

    function goHome() {
      document.getElementById('stamp-area').style.display = 'none';
      document.getElementById('result').innerText = '';
    }

    function renderStamps() {
      const stamps = JSON.parse(localStorage.getItem("stamps") || "[]");
      const container = document.getElementById("stamps");
      container.innerHTML = "";
      let collected = 0;

      stampList.forEach(id => {
        const got = stamps.includes(id);
        let displayName = id;
        let imageSrc = stampImages[id] || 'img/default.png';

        if (id === "å•é¡Œ-1") {
          if (got) {
            displayName = "ç†ç§‘å®¤å‰ (æ‰‰)";
            imageSrc = stampImages[displayName] || imageSrc;
          } else {
            container.innerHTML += `
              <div class="stamp">
                â¬œï¸ <a href="img/å•é¡Œ-1.png" target="_blank" style="color:blue; text-decoration:underline;">å•é¡Œ-1</a>
              </div>`;
            return; // å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸‹ã®é€šå¸¸ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ãªã„ï¼‰
          }
        }
        if (id === "å•é¡Œ-2") {
          if (got) {
            displayName = "å›³æ›¸é¤¨å‰";
            imageSrc = stampImages[displayName] || imageSrc;
          } else {
            container.innerHTML += `
              <div class="stamp">
                â¬œï¸ <a href="img/å•é¡Œ-2.png" target="_blank" style="color:blue; text-decoration:underline;">å•é¡Œ-2</a>
              </div>`;
            return; // å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸‹ã®é€šå¸¸ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ãªã„ï¼‰
          }
        }

        if (got) {
          collected++;
          container.innerHTML += `
            <div class="stamp">
              <img src="${imageSrc}" alt="${displayName}" style="height:100px;"><br>
              âœ… ${displayName}
            </div>`;
        } else {
          container.innerHTML += `
            <div class="stamp">
              â¬œï¸ ${displayName}
            </div>`;
        }
      });

      if (collected === stampList.length) {
        container.innerHTML += `<h2 style="color: green; font-size: 1.5em;">ğŸ‰ å…¨ã¦é›†ã‚ã¾ã—ãŸï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸ‰</h2>`;
      }
    }

    function startScan() {
      document.getElementById('scanner').style.display = 'block';
      document.getElementById('stamp-area').style.display = 'none';
      const qrScanner = new Html5Qrcode("scanner");

      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          qrScanner.stop();
          document.getElementById('scanner').style.display = 'none';

          let stampId;
          try {
            const url = new URL(qrCodeMessage);
            stampId = url.searchParams.get("stamp");
          } catch {
            stampId = qrCodeMessage; // ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œ
          }

          if (stampList.includes(stampId)) {
            let stamps = JSON.parse(localStorage.getItem("stamps") || "[]");
            if (!stamps.includes(stampId)) {
              stamps.push(stampId);
              localStorage.setItem("stamps", JSON.stringify(stamps));
              document.getElementById('result').innerText = `âœ… ${stampId} ã‚’ã‚²ãƒƒãƒˆï¼`;
            } else {
              document.getElementById('result').innerText = `${stampId} ã¯æ—¢ã«å–å¾—æ¸ˆã¿ã§ã™ã€‚`;
            }
          } else {
            document.getElementById('result').innerText = `ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚`;
          }
        },
        errorMessage => {
          // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã¾ãŸã¯è¡¨ç¤ºã—ã¦ã‚‚ã‚ˆã„
        }
      ).catch(err => {
        console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼", err);
      });
    }
  </script>
</body>
</html>
